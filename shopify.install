<?php
/**
 * @file
 * Contains install and uninstall functionality.
 */

/**
 * Implements hook_schema().
 */
function shopify_schema() {
  $schema['shopify_products'] = array(
    'description' => 'Base table for storing Shopify products.',
    'fields' => array(
      'id' => array(
        'description' => 'Shopify product ID',
        'type' => 'serial',
        'not null' => TRUE,
      ),
      'product_id' => array(
        'type' => 'int',
        'description' => 'Product ID',
      ),
      'variant_id' => array(
        'type' => 'int',
        'description' => 'Variant ID',
        'default' => 0,
      ),
      'title' => array(
        'description' => 'Product title',
        'type' => 'varchar',
        'length' => 128,
        'not null' => TRUE,
        'default' => '',
      ),
      'body_html' => array(
        'description' => 'Product body HTML',
        'type' => 'text',
      ),
      'handle' => array(
        'description' => 'Product handle',
        'type' => 'varchar',
        'length' => 32,
      ),
      'product_type' => array(
        'description' => 'Product type',
        'type' => 'varchar',
        'length' => 32,
      ),
      'published_scope' => array(
        'description' => 'Published scope',
        'type' => 'varchar',
        'length' => 32,
      ),
      'vendor' => array(
        'description' => 'Vendor',
        'type' => 'varchar',
        'length' => 32,
      ),
      'tags' => array(
        'description' => 'Tags',
        'type' => 'varchar',
        'length' => 256,
      ),
      'options' => array(
        'description' => 'Options',
        'type' => 'varchar',
        'length' => 256,
      ),
      'barcode' => array(
        'description' => 'Barcode',
        'type' => 'varchar',
        'length' => 32,
      ),
      'compare_at_price' => array(
        'description' => 'Product comparison price',
        'type' => 'numeric',
        'scale' => 2,
        'precision' => 10,
      ),
      'fulfillment_service' => array(
        'description' => 'Fulfillment Service',
        'type' => 'varchar',
        'length' => 16,
      ),
      'grams' => array(
        'description' => 'Grams',
        'type' => 'int',
      ),
      'inventory_management' => array(
        'description' => 'Inventory management',
        'type' => 'varchar',
        'length' => 32,
      ),
      'inventory_policy' => array(
        'description' => 'Inventory policy',
        'type' => 'varchar',
        'length' => 32,
      ),
      'inventory_quantity' => array(
        'description' => 'Inventory quantity',
        'type' => 'int',
      ),
      'old_inventory_quantity' => array(
        'description' => 'Old inventory quantity',
        'type' => 'int',
      ),
      'option_values' => array(
        'description' => 'Option values',
        'type' => 'text',
      ),
      'price' => array(
        'description' => 'Product price',
        'type' => 'numeric',
        'scale' => 2,
        'precision' => 10,
      ),
      'requires_shipping' => array(
        'description' => 'Requires shipping',
        'type' => 'int',
        'size' => 'tiny',
      ),
      'sku' => array(
        'description' => 'SKU',
        'type' => 'varchar',
        'length' => 64,
      ),
      'taxable' => array(
        'description' => 'Requires shipping',
        'type' => 'int',
        'size' => 'tiny',
      ),
      'weight' => array(
        'description' => 'Product weight',
        'type' => 'numeric',
        'precision' => 10,
        'scale' => 2,
      ),
      'weight_unit' => array(
        'description' => 'Weight unit',
        'type' => 'varchar',
        'length' => 8,
      ),
      'created_at' => array(
        'description' => 'Created at',
        'type' => 'varchar',
        'length' => 32,
      ),
      'published_at' => array(
        'description' => 'Published at',
        'type' => 'varchar',
        'length' => 32,
      ),
      'updated_at' => array(
        'description' => 'Updated at',
        'type' => 'varchar',
        'length' => 32,
      ),
    ),
    'primary key' => array('id'),
  );
  return $schema;
}

/**
 * Implements hook_install().
 */
function shopify_install() {

  shopify_products_reset_sync_datestamp();

  field_create_field(array(
    'field_name' => 'shopify_product_images',
    'type' => 'image',
    'cardinality' => -1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_product_images',
    'entity_type' => 'shopify_product',
    'bundle' => 'shopify_product',
    'label' => 'Shopify Product Image',
    'required' => FALSE,
    'default_value_function' => '',
    'widget' => array(
      'type' => 'image_image',
      'settings' => array('image_style' => 'thumbnail', 'image_link' => ''),
    ),
  );

  field_create_instance($instance);

  field_create_field(array(
    'field_name' => 'shopify_product_tags',
    'type' => 'taxonomy_term_reference',
    'cardinality' => -1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_product_tags',
    'entity_type' => 'shopify_product',
    'bundle' => 'shopify_product',
    'label' => 'Shopify Product Tags',
    'required' => FALSE,
    'default_value_function' => '',
    'widget' => array(
      'type' => 'taxonomy_autocomplete',
      'settings' => array(
        'allowed_values' => array(
          'vocabulary' => 'shopify_tags',
          'parent' => 0
        )
      ),
    ),
  );

  field_create_instance($instance);

  $vocabulary = new stdClass;
  $vocabulary->name = 'Shopify Tags';
  $vocabulary->machine_name = 'shopify_tags';
  taxonomy_vocabulary_save($vocabulary);

  // Create field and taxonomy for collections.
  field_create_field(array(
    'field_name' => 'shopify_product_collections',
    'type' => 'taxonomy_term_reference',
    'cardinality' => -1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_product_collections',
    'entity_type' => 'shopify_product',
    'bundle' => 'shopify_product',
    'label' => 'Shopify Collections',
    'required' => FALSE,
    'default_value_function' => '',
    'widget' => array(
      'type' => 'taxonomy_autocomplete',
      'settings' => array(
        'allowed_values' => array(
          'vocabulary' => 'shopify_collections',
          'parent' => 0
        ),
      ),
    ),
  );

  field_create_instance($instance);

  $vocabulary = new stdClass;
  $vocabulary->name = 'Shopify Collections';
  $vocabulary->machine_name = 'shopify_collections';
  taxonomy_vocabulary_save($vocabulary);

  // Create collection image field.
  field_create_field(array(
    'field_name' => 'shopify_collection_image',
    'type' => 'image',
    'cardinality' => 1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_collection_image',
    'entity_type' => 'taxonomy_term',
    'bundle' => 'shopify_collections',
    'label' => 'Shopify Collection Image',
    'required' => FALSE,
    'default_value_function' => '',
    'widget' => array(
      'type' => 'image_image',
      'settings' => array('image_style' => 'thumbnail', 'image_link' => ''),
    ),
  );

  field_create_instance($instance);

  $instance = field_info_instance('shopify_product', 'shopify_product_images', 'shopify_product');
  $instance['display'] = array(
    'default' =>
      array(
        'label' => 'hidden',
        'type' => 'image',
        'weight' => '0',
        'settings' =>
          array(
            'image_style' => 'shopify_product_thumbnail',
            'image_link' => '',
          ),
        'module' => 'image',
      ),
  );
  field_update_instance($instance);

  $instance = field_info_instance('shopify_product', 'shopify_product_tags', 'shopify_product');
  $instance['display'] = array(
    0 =>
      array(
        'default' =>
          array(
            'label' => 'hidden',
            'type' => 'taxonomy_term_reference_link',
            'settings' =>
              array(),
            'module' => 'taxonomy',
            'weight' => 1,
          ),
        'label' => 'hidden',
        'type' => 'taxonomy_term_reference_link',
        'settings' =>
          array(),
        'module' => 'taxonomy',
        'weight' => 33,
      ),
    'default' =>
      array(
        'label' => 'hidden',
        'type' => 'taxonomy_term_reference_link',
        'weight' => '4',
        'settings' =>
          array(),
        'module' => 'taxonomy',
      ),
  );

  field_update_instance($instance);

  $vocabulary = new stdClass;
  $vocabulary->name = 'Shopify Collections';
  $vocabulary->machine_name = 'shopify_collections';
  taxonomy_vocabulary_save($vocabulary);

  // Create collection image field.
  field_create_field(array(
    'field_name' => 'shopify_collection_image',
    'type' => 'image',
    'cardinality' => 1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_collection_image',
    'entity_type' => 'taxonomy_term',
    'bundle' => 'shopify_collections',
    'label' => 'Shopify Collection Image',
    'required' => FALSE,
    'default_value_function' => '',
    'widget' => array(
      'type' => 'image_image',
      'settings' => array('image_style' => 'thumbnail', 'image_link' => ''),
    ),
  );

  field_create_instance($instance);

  // Create field to track the collection ID from Shopify.
  field_create_field(array(
    'field_name' => 'shopify_collection_id',
    'type' => 'number_integer',
    'cardinality' => 1,
    'settings' => array(),
  ));

  $instance = array(
    'field_name' => 'shopify_collection_id',
    'entity_type' => 'taxonomy_term',
    'bundle' => 'shopify_collections',
    'label' => 'Shopify Collection ID',
    'required' => TRUE,
    'default_value_function' => '',
  );

  field_create_instance($instance);


  $instance = field_info_instance('shopify_product', 'shopify_product_images', 'shopify_product');
  $instance['display'] = array(
    'default' =>
      array(
        'label' => 'hidden',
        'type' => 'image',
        'weight' => '0',
        'settings' =>
          array(
            'image_style' => 'shopify_product_thumbnail',
            'image_link' => '',
          ),
        'module' => 'image',
      ),
  );
  field_update_instance($instance);

  $product_settings = array(
    'view_modes' =>
      array(
        'full' =>
          array(
            'custom_settings' => FALSE,
          ),
        'teaser' =>
          array(
            'custom_settings' => FALSE,
          ),
        'token' =>
          array(
            'custom_settings' => FALSE,
          ),
      ),
    'extra_fields' =>
      array(
        'form' =>
          array(
            'metatags' =>
              array (
                'weight' => '99',
              ),
          ),
        'display' =>
          array(
            'product_id' =>
              array(
                'default' =>
                  array(
                    'weight' => '26',
                    'visible' => FALSE,
                  ),
              ),
            'variant_id' =>
              array(
                'default' =>
                  array(
                    'weight' => '25',
                    'visible' => FALSE,
                  ),
              ),
            'body_html' =>
              array(
                'default' =>
                  array(
                    'weight' => '2',
                    'visible' => TRUE,
                  ),
              ),
            'price' =>
              array(
                'default' =>
                  array(
                    'weight' => '4',
                    'visible' => FALSE,
                  ),
              ),
            'updated_at' =>
              array(
                'default' =>
                  array(
                    'weight' => '17',
                    'visible' => FALSE,
                  ),
              ),
            'created_at' =>
              array(
                'default' =>
                  array(
                    'weight' => '21',
                    'visible' => FALSE,
                  ),
              ),
            'published_at' =>
              array(
                'default' =>
                  array(
                    'weight' => '20',
                    'visible' => FALSE,
                  ),
              ),
            'title' =>
              array(
                'default' =>
                  array(
                    'weight' => '0',
                    'visible' => TRUE,
                  ),
              ),
            'handle' =>
              array(
                'default' =>
                  array(
                    'weight' => '8',
                    'visible' => FALSE,
                  ),
              ),
            'product_type' =>
              array(
                'default' =>
                  array(
                    'weight' => '6',
                    'visible' => FALSE,
                  ),
              ),
            'published_scope' =>
              array(
                'default' =>
                  array(
                    'weight' => '22',
                    'visible' => FALSE,
                  ),
              ),
            'vendor' =>
              array(
                'default' =>
                  array(
                    'weight' => '23',
                    'visible' => FALSE,
                  ),
              ),
            'barcode' =>
              array(
                'default' =>
                  array(
                    'weight' => '24',
                    'visible' => FALSE,
                  ),
              ),
            'compare_at_price' =>
              array(
                'default' =>
                  array(
                    'weight' => '19',
                    'visible' => FALSE,
                  ),
              ),
            'fulfillment_service' =>
              array(
                'default' =>
                  array(
                    'weight' => '18',
                    'visible' => FALSE,
                  ),
              ),
            'grams' =>
              array(
                'default' =>
                  array(
                    'weight' => '11',
                    'visible' => FALSE,
                  ),
              ),
            'inventory_management' =>
              array(
                'default' =>
                  array(
                    'weight' => '10',
                    'visible' => FALSE,
                  ),
              ),
            'inventory_policy' =>
              array(
                'default' =>
                  array(
                    'weight' => '9',
                    'visible' => FALSE,
                  ),
              ),
            'inventory_quantity' =>
              array(
                'default' =>
                  array(
                    'weight' => '12',
                    'visible' => FALSE,
                  ),
              ),
            'requires_shipping' =>
              array(
                'default' =>
                  array(
                    'weight' => '13',
                    'visible' => FALSE,
                  ),
              ),
            'sku' =>
              array(
                'default' =>
                  array(
                    'weight' => '16',
                    'visible' => FALSE,
                  ),
              ),
            'taxable' =>
              array(
                'default' =>
                  array(
                    'weight' => '15',
                    'visible' => FALSE,
                  ),
              ),
            'weight' =>
              array(
                'default' =>
                  array(
                    'weight' => '14',
                    'visible' => FALSE,
                  ),
              ),
            'weight_unit' =>
              array(
                'default' =>
                  array(
                    'weight' => '7',
                    'visible' => FALSE,
                  ),
              ),
            'add_to_cart' =>
              array(
                'default' =>
                  array(
                    'weight' => '3',
                    'visible' => TRUE,
                  ),
              ),
          ),
      ),
  );

  variable_set('field_bundle_settings_shopify_product__shopify_product', $product_settings);
  // Please keep the product settings last.

}

/**
 * Implements hook_uninstall().
 */
function shopify_uninstall() {
  field_delete_field('shopify_product_images');
  field_delete_field('shopify_collection_image');
  field_delete_field('shopify_product_tags');
  field_delete_field('shopify_product_collections');
  field_delete_field('shopify_collection_id');
  $vocabulary = taxonomy_vocabulary_machine_name_load('shopify_tags');
  taxonomy_vocabulary_delete($vocabulary->vid);
  $vocabulary = taxonomy_vocabulary_machine_name_load('shopify_collections');
  taxonomy_vocabulary_delete($vocabulary->vid);
  variable_del('shopify_last_sync');
  variable_del('shopify_store_info');
  field_purge_batch(20);
}
